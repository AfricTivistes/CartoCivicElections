// Add popup on hover
map.on('mouseenter', 'points', () => {
  map.getCanvas().style.cursor = 'pointer';
});

map.on('mouseleave', 'points', () => {
  map.getCanvas().style.cursor = '';
});

map.on('style.load', async () => {
  try {
    const response = await fetch('/api/map.json');
    const data = await response.json();
    
    if (map.getSource('initiatives')) {
      map.removeSource('initiatives');
    }
    
    map.addSource('initiatives', {
      type: 'geojson',
      data: data
    });

    if (map.getLayer('points')) {
      map.removeLayer('points');
    }

    map.addLayer({
      'id': 'points',
      'type': 'circle',
      'source': 'initiatives',
      'paint': {
        'circle-radius': 8,
        'circle-color': '#FF6B6B',
        'circle-stroke-width': 2,
        'circle-stroke-color': '#fff'
      }
    });

    // Add click event
    map.on('click', 'points', (e) => {
      if (e.features.length > 0) {
        const country = e.features[0].properties.title;
        const basePath = window.location.pathname.startsWith('/fr') ? '/fr' : '';
        window.location.href = `${basePath}/initiatives/?tags=${encodeURIComponent(country)}`;
      }
    });
  } catch (error) {
    console.error('Erreur lors du chargement des points:', error);
  }

  map.on('click', 'points', (e) => {
    const coordinates = e.features[0].geometry.coordinates.slice();
    const description = e.features[0].properties.description;
    const country = e.features[0].properties.title;

    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
      coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
    }

    new mapboxgl.Popup()
      .setLngLat(coordinates)
      .setHTML(description)
      .addTo(map);

    // Redirection vers la page des initiatives avec le pays en filtre
    const basePath = window.location.pathname.startsWith('/fr') ? '/fr' : '';
    window.location.href = `${basePath}/initiatives/?tags=${encodeURIComponent(country)}`;
  });
});