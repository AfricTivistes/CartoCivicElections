
---
import { api } from './api/nocodb';

interface PageInfo {
  totalRows: number;
  page: number;
  pageSize: number;
  totalPages: number;
}

interface ApiResponse {
  list: any[];
  pageInfo: PageInfo;
}

// Fonction utilitaire pour ajouter un délai
const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

export const getData = async (tableId: string, query: object = {}) => {
  try {
    const response = await api.get(`/api/v2/tables/${tableId}/records`, { params: query });
    return response.data;
  } catch (error) {
    console.error('Error fetching data:', error);
    throw error;
  }
};

export const getAll = async (tableId: string, query: object = {}) => {
  try {
    let allRecords = [];
    let page = 1;
    let hasMore = true;
    let totalRows = 0;
    
    // Délai minimal entre les requêtes (en ms) pour respecter la limite de 5 req/sec
    const REQUEST_DELAY = 250; // 250ms = 4 requêtes par seconde max
    const baseParams = {
      viewId: query?.viewId,
      fields: query?.fields,
      where: query?.where
    };
    
    // Première requête pour obtenir le nombre total d'enregistrements
    const firstResponse = await api.get(`/api/v2/tables/${tableId}/records`, {
      params: {
        ...baseParams,
        limit: 100,
        page: 1
      }
    });
    
    const firstData = firstResponse.data as ApiResponse;
    if (!firstData.pageInfo) {
      throw new Error('Format de réponse API invalide : pageInfo manquant');
    }
    
    totalRows = firstData.pageInfo.totalRows;
    allRecords = [...firstData.list];
    
    // Calcul du nombre total de pages
    const totalPages = Math.ceil(totalRows / 100);
    
    // Récupération des pages restantes
    while (page < totalPages) {
      page++;
      
      try {
        const response = await api.get(`/api/v2/tables/${tableId}/records`, {
          params: {
            ...baseParams,
            limit: 100,
            page: page
          }
        });
        
        const data = response.data as ApiResponse;
        if (!data.list) {
          throw new Error(`Format de réponse API invalide pour la page ${page}`);
        }
        
        allRecords = [...allRecords, ...data.list];
        
        // Délai entre les requêtes pour respecter la limite de rate
        await delay(REQUEST_DELAY);
        
      } catch (error) {
        console.error(`Erreur lors de la récupération de la page ${page}:`, error);
        throw new Error(`Échec de la récupération de la page ${page}`);
      }
    }
    
    return {
      list: allRecords,
      total: allRecords.length,
      pageInfo: {
        totalRows,
        totalPages,
        pageSize: 100
      }
    };
    
  } catch (error) {
    console.error('Erreur lors de la récupération de toutes les données:', error);
    throw error;
  }
};

export const insertData = async (tableId: string, data: object[]) => {
  try {
    const response = await api.post(`/api/v2/tables/${tableId}/records`, data);
    return response.data;
  } catch (error) {
    console.error('Error inserting data:', error);
    throw error;
  }
};

export const deleteData = async (tableId: string, recordIds: string[]) => {
  try {
    const response = await api.delete(`/api/v2/tables/${tableId}/records`, { data: recordIds });
    return response.data;
  } catch (error) {
    console.error('Error deleting data:', error);
    throw error;
  }
};
---
