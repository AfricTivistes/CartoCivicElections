---
import MainLayout from "@/layouts/MainLayout.astro";
import { getAll } from "@/lib/contentNocodb.astro";
import SimilarInitiatives from "@/components/SimilarInitiatives";

const { slug } = Astro.params;

// Fetch all initiatives
const tableId = "m9erh9bplb8jihp";
const query = {
  viewId: "vwdobxvm00ayso6s",
  fields: [
    "Nom de l'initiative",
    "Pays",
    "Catégorie de l'initiative",
    "Thématique de l'initiative",
    "Description",
    "Langue",
  ],
  where: "(Status,eq,Traiter)~and(Langue,eq,en)",
};

const rawInitiatives = await getAll(tableId, query);
const initiatives = rawInitiatives?.list?.map((initiative) => ({
  title: initiative["Nom de l'initiative"],
  country: initiative["Pays"],
  category: initiative["Catégorie de l'initiative"],
  thematic: initiative["Thématique de l'initiative"],
  description: initiative["Description"],
  langue: initiative["Langue"],
})) || [];

const currentInitiative = initiatives.find(
  (initiative) => slug === initiative.title?.toLowerCase().replace(/\s+/g, "-")
);

if (!currentInitiative) {
  return Astro.redirect("/404");
}
---

<MainLayout title={currentInitiative.title}>
  <div class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8 lg:py-14">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">
        {currentInitiative.title}
      </h1>

      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex items-center mb-4">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 text-primary-500 mr-2"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
              clip-rule="evenodd"></path>
          </svg>
          <a
            href={`/initiatives?tags=${encodeURIComponent(currentInitiative.country)}`}
            class="text-lg text-primary-700 hover:underline transition-colors duration-200"
          >
            {currentInitiative.country}
          </a>
        </div>

        <div class="flex items-center mb-4">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 text-primary-500 mr-2"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"
            ></path>
            <path
              fill-rule="evenodd"
              d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z"
              clip-rule="evenodd"></path>
          </svg>
          <a
            href={`/initiatives?tags=${encodeURIComponent(currentInitiative.category)}`}
            class="text-primary-700 hover:underline transition-colors duration-200"
          >
            {currentInitiative.category}
          </a>
        </div>

        <div class="flex items-center mb-6">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 text-primary-500 mr-2"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M2 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 002 2H4a2 2 0 01-2-2V5zm3 1h6v4H5V6zm6 6H5v2h6v-2z"
              clip-rule="evenodd"></path>
          </svg>
          <a
            href={`/initiatives?tags=${encodeURIComponent(currentInitiative.thematic)}`}
            class="text-primary-700 hover:underline transition-colors duration-200"
          >
            {currentInitiative.thematic}
          </a>
        </div>

        <div class="prose max-w-none">
          <p class="text-gray-600">{currentInitiative.description}</p>
        </div>
      </div>

      <SimilarInitiatives
        client:load
        currentInitiative={currentInitiative}
        allInitiatives={initiatives}
        language="en"
      />
    </div>
  </div>
</MainLayout>